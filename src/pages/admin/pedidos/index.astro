---
import Layout from '../../../layouts/Layout.astro'
import { getDB } from '../../../db'
import { pedidosTable, estilosTable, tallasTable, pedidoItemsTable } from '../../../db/schema'
import { eq, sql } from 'drizzle-orm'
import CheckIcon from '../../../components/icons/CheckIcon.astro'
import ClockIcon from '../../../components/icons/ClockIcon.astro'
import TrashIcon from '../../../components/icons/TrashIcon.astro'

const db = getDB(Astro.locals.runtime.env)

// Fetch orders with aggregated styles and size info
const orders = await db
  .select({
    id: pedidosTable.id,
    persona: pedidosTable.persona,
    nombre: pedidosTable.nombre,
    total: pedidosTable.total,
    pagado: pedidosTable.pagado,
    estilos: sql<string>`group_concat(${estilosTable.nombre}, ', ')`,
    talla: tallasTable.talla,
  })
  .from(pedidosTable)
  .leftJoin(pedidoItemsTable, eq(pedidoItemsTable.pedidoId, pedidosTable.id))
  .leftJoin(estilosTable, eq(pedidoItemsTable.estiloId, estilosTable.id))
  .leftJoin(tallasTable, eq(pedidosTable.tallaId, tallasTable.id))
  .groupBy(pedidosTable.id)
---

<Layout>
  <main class="py-20 px-6 min-h-screen">
    <div class="max-w-5xl mx-auto">
      <header class="mb-12 flex justify-between items-end">
        <div>
          <a
            href="/admin"
            class="text-gray-400 hover:text-white transition-colors flex items-center gap-2 mb-4"
          >
            <svg
              class="w-4 h-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              ><path d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg
            > Volver al Panel
          </a>
          <h1 class="text-4xl font-bold text-white">Gestión de Pedidos</h1>
        </div>
        <div class="text-gray-400 font-medium">
          Total: <span class="text-white">{orders.length}</span> pedidos
        </div>
      </header>

      <div
        class="bg-white/5 border border-white/10 rounded-3xl overflow-hidden backdrop-blur-sm"
      >
        <table class="w-full text-left">
          <thead>
            <tr class="border-b border-white/10 bg-white/5">
              <th class="px-6 py-4 font-bold text-gray-300">Cliente</th>
              <th class="px-6 py-4 font-bold text-gray-300">Nombre Camisa</th>
              <th class="px-6 py-4 font-bold text-gray-300">Estilos</th>
              <th class="px-6 py-4 font-bold text-gray-300">Talla</th>
              <th class="px-6 py-4 font-bold text-gray-300">Total</th>
              <th class="px-6 py-4 font-bold text-gray-300">Estado</th>
              <th class="px-6 py-4 font-bold text-gray-300">Acciones</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-white/10">
            {
              orders.map((order) => (
                <tr class="hover:bg-white/5 transition-colors">
                  <td class="px-6 py-4 font-bold">{order.persona}</td>
                  <td class="px-6 py-4 text-gray-400 italic">
                    "{order.nombre}"
                  </td>
                  <td class="px-6 py-4 text-sm text-gray-300">{order.estilos || '-'}</td>
                  <td class="px-6 py-4 font-bold">{order.talla}</td>
                  <td class="px-6 py-4 font-bold text-orange-500">
                    ${order.total}
                  </td>
                  <td class="px-6 py-4">
                    {order.pagado ? (
                      <span class="text-green-500 flex items-center gap-1 font-bold text-sm">
                        <svg
                          class="w-4 h-4"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path d="M5 13l4 4L19 7" />
                        </svg>{' '}
                        Pagado
                      </span>
                    ) : (
                      <span class="text-orange-500 flex items-center gap-1 font-bold text-sm">
                        <svg
                          class="w-4 h-4"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>{' '}
                        Pendiente
                      </span>
                    )}
                  </td>
                  <td class="px-6 py-4">
                    <div class="flex items-center gap-2">
                      <form method="post" action="/api/pedidos/toggle">
                        <input type="hidden" name="id" value={order.id} />
                        <button
                          type="submit"
                          class={`inline-flex items-center justify-center w-9 h-9 rounded-full border transition-colors ${order.pagado ? 'bg-white/10 hover:bg-white/20 border-white/20 text-white' : 'bg-green-500/10 hover:bg-green-500/20 border-green-500/20 text-green-400'}`}
                          title={order.pagado ? 'Marcar como pendiente' : 'Marcar como pagado'}
                          aria-label={order.pagado ? 'Marcar como pendiente' : 'Marcar como pagado'}
                        >
                          {order.pagado ? (
                            <ClockIcon />
                          ) : (
                            <CheckIcon />
                          )}
                        </button>
                      </form>
                      <form method="post" action="/api/pedidos/delete" onsubmit="return confirm('¿Seguro que deseas borrar este pedido? Esta acción no se puede deshacer.')">
                        <input type="hidden" name="id" value={order.id} />
                        <button
                          type="submit"
                          class="inline-flex items-center justify-center w-9 h-9 rounded-full border border-red-500/30 bg-red-500/10 hover:bg-red-500/20 text-red-400 transition-colors"
                          title="Borrar pedido"
                          aria-label="Borrar pedido"
                        >
                          <TrashIcon />
                        </button>
                      </form>
                    </div>
                  </td>
                </tr>
              ))
            }
            {
              orders.length === 0 && (
                <tr>
                  <td
                    colspan="7"
                    class="px-6 py-20 text-center text-gray-500 italic"
                  >
                    No hay pedidos registrados aún.
                  </td>
                </tr>
              )
            }
          </tbody>
        </table>
      </div>
    </div>
  </main>
</Layout>
