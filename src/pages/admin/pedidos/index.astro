---
import Layout from '../../../layouts/Layout.astro'
import UserBadge from '../../../components/admin/UserBadge.astro'
import { getDB } from '../../../db'
import { pedidosTable, estilosTable, tallasTable, pedidoItemsTable } from '../../../db/schema'
import { eq, sql } from 'drizzle-orm'
import CheckIcon from '../../../components/icons/CheckIcon.astro'
import ClockIcon from '../../../components/icons/ClockIcon.astro'
import TrashIcon from '../../../components/icons/TrashIcon.astro'
import PaymentIcon from '../../../components/icons/PaymentIcon.astro'

const db = getDB(Astro.locals.runtime.env)

// Fetch all available styles for the edit modal
const allStyles = await db
  .select()
  .from(estilosTable)
  .orderBy(estilosTable.estilo, estilosTable.nombre)

const groupedStyles = allStyles.reduce((acc, estilo) => {
  if (!acc[estilo.estilo]) acc[estilo.estilo] = []
  acc[estilo.estilo].push(estilo)
  return acc
}, {} as Record<number, typeof allStyles>)

const collectionNumbers = Object.keys(groupedStyles).map(Number).sort((a, b) => b - a)

// Fetch orders with aggregated styles and size info
const orders = await db
  .select({
    id: pedidosTable.id,
    persona: pedidosTable.persona,
    nombre: pedidosTable.nombre,
    total: pedidosTable.total,
    pagado: pedidosTable.pagado,
    abonado: pedidosTable.abonado,
    createdAt: pedidosTable.createdAt,
    estilos: sql<string>`group_concat(${estilosTable.nombre}, ', ')`,
    estiloIds: sql<string>`group_concat(${estilosTable.id}, ',')`,
    talla: tallasTable.talla,
  })
  .from(pedidosTable)
  .leftJoin(pedidoItemsTable, eq(pedidoItemsTable.pedidoId, pedidosTable.id))
  .leftJoin(estilosTable, eq(pedidoItemsTable.estiloId, estilosTable.id))
  .leftJoin(tallasTable, eq(pedidosTable.tallaId, tallasTable.id))
  .groupBy(
    pedidosTable.id,
    pedidosTable.persona,
    pedidosTable.nombre,
    pedidosTable.total,
    pedidosTable.pagado,
    pedidosTable.abonado,
    tallasTable.talla
  )
---

<Layout>
  <main class="py-10 md:py-20 px-4 sm:px-6 min-h-screen">
    <div class="max-w-5xl mx-auto">
      <header class="mb-12 flex flex-col sm:flex-row justify-between items-start sm:items-end gap-4" data-orders={JSON.stringify(orders)}>
        <div>
          <a
            href="/admin"
            class="text-gray-400 hover:text-white transition-colors flex items-center gap-2 mb-4"
          >
            <svg
              class="w-4 h-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              ><path d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg
            > Volver al Panel
          </a>
          <h1 class="text-3xl sm:text-4xl font-bold text-white uppercase tracking-tight">Gestión de Pedidos</h1>
        </div>
        <div class="flex items-center gap-4">
          <button
            type="button"
            id="report-open"
            class="flex items-center gap-2 px-4 py-2 rounded-full bg-white/5 border border-white/10 text-gray-300 hover:bg-white/10 hover:text-white transition-all cursor-pointer text-sm font-bold"
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            Generar Informe
          </button>
          <div class="text-gray-400 font-medium bg-white/5 px-4 py-2 rounded-full border border-white/10 text-sm">
            Total: <span class="text-white font-bold">{orders.length}</span> pedidos
          </div>
          <UserBadge />
        </div>
      </header>

      <!-- Vista Mobile (Tarjetas) -->
      <div class="grid gap-4 md:hidden mb-8">
        {
          orders.map((order) => {
            const isPagado = order.pagado;
            const isAbonado = order.abonado > 0 && !isPagado;
            const saldoPendiente = order.total - order.abonado;
            const porcentajeAbonado = Math.round((order.abonado / order.total) * 100);
            const statusColor = isPagado ? 'text-green-500' : isAbonado ? 'text-blue-400' : 'text-orange-500';
            const estilosArray = order.estilos ? order.estilos.split(', ') : [];
            const fecha = order.createdAt ? new Date(order.createdAt).toLocaleDateString('es-ES', {
              day: '2-digit',
              month: '2-digit',
              year: 'numeric'
            }) : '---';

            return (
              <div class="bg-white/5 border border-white/10 rounded-2xl p-5 space-y-4 backdrop-blur-sm">
                <div class="flex justify-between items-start">
                  <div class="space-y-1">
                    <div class="flex items-center gap-2">
                      <h3 class="text-lg font-bold text-white leading-tight">{order.persona}</h3>
                      <button
                        type="button"
                        class="text-[10px] font-medium text-gray-500 bg-white/5 px-1.5 py-0.5 rounded border border-white/5 hover:bg-white/10 hover:text-white transition-colors cursor-pointer"
                        data-edit-date-id={order.id}
                        data-edit-date-current={order.createdAt ? new Date(order.createdAt).toISOString().split('T')[0] : ''}
                        data-edit-date-persona={order.persona}
                        title="Editar fecha"
                      >
                        {fecha}
                      </button>
                    </div>
                    <p class="text-gray-400 italic text-sm">"{order.nombre}"</p>
                  </div>
                  <div class="text-right">
                    <div class={`text-xl font-black ${statusColor}`}>
                      ${order.total}
                    </div>
                    {!isPagado && (
                      <div class="text-[10px] font-bold text-red-400/80 uppercase tracking-tighter mt-1">
                        Saldo: ${saldoPendiente}
                      </div>
                    )}
                  </div>
                </div>

                <div class="grid grid-cols-2 gap-4 py-3 border-y border-white/5">
                  <div>
                    <span class="text-[10px] font-black text-gray-500 uppercase tracking-widest block mb-1">Talla</span>
                    <span class="text-white font-bold bg-white/10 px-2 py-1 rounded text-xs">{order.talla}</span>
                  </div>
                  <div>
                    <span class="text-[10px] font-black text-gray-500 uppercase tracking-widest block mb-1">Estilos</span>
                    <div class="flex flex-wrap gap-1">
                      {estilosArray.length > 0 ? (
                        estilosArray.map((estilo) => (
                          <span class="px-1.5 py-0.5 rounded bg-white/10 text-[9px] font-bold text-gray-300 uppercase tracking-tight break-words max-w-full">
                            {estilo}
                          </span>
                        ))
                      ) : (
                        <span class="text-gray-500 text-[10px] italic">-</span>
                      )}
                    </div>
                  </div>
                </div>

                <div class="flex flex-col sm:flex-row justify-between items-center gap-4 pt-2">
                  <div class="w-full sm:w-auto">
                    {isPagado ? (
                      <span class="text-green-500 flex items-center gap-1.5 font-bold text-sm bg-green-500/10 px-3 py-1.5 rounded-full border border-green-500/20 w-fit">
                        <CheckIcon /> Pagado
                      </span>
                    ) : isAbonado ? (
                      <div class="flex flex-col gap-1">
                        <span class="text-blue-400 flex items-center gap-1.5 font-bold text-sm bg-blue-400/10 px-3 py-1.5 rounded-full border border-blue-400/20 w-fit">
                          <PaymentIcon class="w-4 h-4" badgeClass="w-3 h-3 text-[8px]" />
                          Abonado (${order.abonado})
                        </span>
                        <span class="text-[10px] text-blue-400/60 font-bold uppercase tracking-tighter ml-2">
                          {porcentajeAbonado}% del total
                        </span>
                      </div>
                    ) : (
                      <span class="text-orange-500 flex items-center gap-1.5 font-bold text-sm bg-orange-500/10 px-3 py-1.5 rounded-full border border-orange-500/20 w-fit">
                        <ClockIcon /> Pendiente
                      </span>
                    )}
                  </div>

                  <div class="flex flex-wrap items-center gap-3 w-full sm:w-auto justify-end">
                    <form method="post" action="/api/pedidos/toggle">
                      <input type="hidden" name="id" value={order.id} />
                      <button
                        type="submit"
                        class={`inline-flex items-center justify-center w-11 h-11 rounded-xl border transition-all active:scale-95 cursor-pointer ${order.pagado ? 'bg-white/5 border-white/10 text-white' : 'bg-green-500/10 border-green-500/20 text-green-400'}`}
                        title={order.pagado ? 'Marcar como pendiente' : 'Marcar como pagado'}
                      >
                        {order.pagado ? <ClockIcon /> : <CheckIcon />}
                      </button>
                    </form>
                    <button
                      type="button"
                      class="group inline-flex items-center justify-center w-11 h-11 rounded-xl border border-blue-500/30 bg-blue-500/10 text-blue-400 transition-all active:scale-95 cursor-pointer"
                      data-abono-id={order.id}
                      data-abono-total={order.total}
                      data-abono-actual={order.abonado}
                      data-abono-persona={order.persona}
                      title="Registrar abono"
                    >
                      <PaymentIcon class="w-6 h-6" badgeClass="w-4 h-4 text-[10px] group-hover:animate-bounce" />
                    </button>
                    <button
                      type="button"
                      class="inline-flex items-center justify-center w-11 h-11 rounded-xl border border-orange-500/30 bg-orange-500/10 text-orange-400 transition-all active:scale-95 cursor-pointer"
                      data-edit-styles-id={order.id}
                      data-edit-styles-persona={order.persona}
                      data-edit-styles-current={order.estiloIds}
                      title="Editar estilos"
                    >
                      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                      </svg>
                    </button>
                    <button
                      type="button"
                      class="inline-flex items-center justify-center w-11 h-11 rounded-xl border border-red-500/30 bg-red-500/10 text-red-400 transition-all active:scale-95 cursor-pointer"
                      data-delete-id={order.id}
                      title="Eliminar pedido"
                    >
                      <TrashIcon />
                    </button>
                  </div>
                </div>
              </div>
            );
          })
        }
        {orders.length === 0 && <p class="text-center text-gray-500 italic py-10">No hay pedidos registrados.</p>}
      </div>

      <!-- Vista Desktop (Tabla) -->
      <div
        class="hidden md:block bg-white/5 border border-white/10 rounded-3xl overflow-hidden backdrop-blur-sm shadow-2xl"
      >
        <table class="w-full text-left">
          <thead>
            <tr class="border-b border-white/10 bg-white/5">
              <th class="px-6 py-4 font-bold text-gray-300">Fecha</th>
              <th class="px-6 py-4 font-bold text-gray-300">Cliente</th>
              <th class="px-6 py-4 font-bold text-gray-300">Nombre Camisa</th>
              <th class="px-6 py-4 font-bold text-gray-300">Estilos</th>
              <th class="px-6 py-4 font-bold text-gray-300">Talla</th>
              <th class="px-6 py-4 font-bold text-gray-300">Total</th>
              <th class="px-6 py-4 font-bold text-gray-300">Estado</th>
              <th class="px-6 py-4 font-bold text-gray-300">Acciones</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-white/10">
            {
              orders.map((order) => {
                const isPagado = order.pagado;
                const isAbonado = order.abonado > 0 && !isPagado;
                 const isPendiente = !isPagado && !isAbonado;
                 const saldoPendiente = order.total - order.abonado;
                 const porcentajeAbonado = Math.round((order.abonado / order.total) * 100);
                 const estilosArray = order.estilos ? order.estilos.split(', ') : [];
                 const fecha = order.createdAt ? new Date(order.createdAt).toLocaleDateString('es-ES', {
                   day: '2-digit',
                   month: '2-digit',
                   year: 'numeric'
                 }) : '---';
                 
                 const statusColor = isPagado 
                   ? 'text-green-500' 
                   : isAbonado 
                     ? 'text-blue-400' 
                     : 'text-orange-500';

                 return (
                   <tr class="hover:bg-white/5 transition-colors group">
                     <td class="px-6 py-4 text-sm text-gray-500 font-medium">
                       <button
                         type="button"
                         class="hover:text-white transition-colors cursor-pointer flex items-center gap-1.5 group/date"
                         data-edit-date-id={order.id}
                         data-edit-date-current={order.createdAt ? new Date(order.createdAt).toISOString().split('T')[0] : ''}
                         data-edit-date-persona={order.persona}
                         title="Editar fecha"
                       >
                         {fecha}
                         <svg class="w-3 h-3 opacity-0 group-hover/date:opacity-100 transition-opacity" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                         </svg>
                       </button>
                     </td>
                     <td class="px-6 py-4 font-bold">{order.persona}</td>
                     <td class="px-6 py-4 text-gray-400 italic">
                       "{order.nombre}"
                     </td>
                     <td class="px-6 py-4">
                        <div class="flex flex-wrap gap-1.5 max-w-[200px]">
                          {estilosArray.length > 0 ? (
                            estilosArray.map((estilo) => (
                              <span class="px-2 py-0.5 rounded-md bg-white/5 border border-white/10 text-[10px] font-bold text-gray-300 uppercase tracking-tight break-words max-w-full group-hover:border-orange-500/30 transition-colors">
                                {estilo}
                              </span>
                            ))
                          ) : (
                            <span class="text-gray-500 text-xs italic">-</span>
                          )}
                        </div>
                     </td>
                     <td class="px-6 py-4 font-bold">{order.talla}</td>
                    <td class="px-6 py-4">
                      <div class={`font-black ${statusColor}`}>
                        ${order.total}
                      </div>
                      {!isPagado && (
                        <div class="text-[10px] font-bold text-red-400/70 uppercase tracking-tighter">
                          Saldo: ${saldoPendiente}
                        </div>
                      )}
                    </td>
                    <td class="px-6 py-4">
                      {isPagado ? (
                        <span class="text-green-500 flex items-center gap-1 font-bold text-sm">
                          <svg
                            class="w-4 h-4"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path d="M5 13l4 4L19 7" />
                          </svg>
                          Pagado
                        </span>
                      ) : isAbonado ? (
                        <span class="text-blue-400 flex flex-col gap-0.5 font-bold text-sm">
                          <div class="flex items-center gap-1">
                            <PaymentIcon class="w-5 h-5" badgeClass="w-3 h-3 text-[8px]" />
                            Abonado (${order.abonado})
                          </div>
                          <div class="text-[10px] ml-5 text-blue-400/70 uppercase tracking-tighter">
                            {porcentajeAbonado}% del total
                          </div>
                        </span>
                      ) : (
                        <span class="text-orange-500 flex items-center gap-1 font-bold text-sm">
                          <svg
                            class="w-4 h-4"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                          </svg>
                          Pendiente
                        </span>
                      )}
                    </td>
                    <td class="px-6 py-4">
                      <div class="flex flex-wrap items-center gap-2 max-w-[160px]">
                        <form method="post" action="/api/pedidos/toggle">
                          <input type="hidden" name="id" value={order.id} />
                          <button
                            type="submit"
                            class={`inline-flex items-center justify-center w-9 h-9 rounded-full border transition-colors cursor-pointer ${order.pagado ? 'bg-white/10 hover:bg-white/20 border-white/20 text-white' : 'bg-green-500/10 hover:bg-green-500/20 border-green-500/20 text-green-400'}`}
                            title={order.pagado ? 'Marcar como pendiente' : 'Marcar como pagado'}
                            aria-label={order.pagado ? 'Marcar como pendiente' : 'Marcar como pagado'}
                          >
                            {order.pagado ? <ClockIcon /> : <CheckIcon />}
                          </button>
                        </form>
                        <button
                          type="button"
                          class="group inline-flex items-center justify-center w-10 h-10 rounded-xl border border-blue-500/30 bg-blue-500/10 hover:bg-blue-500/20 text-blue-400 transition-all duration-300 hover:scale-110 active:scale-95 cursor-pointer"
                          title="Registrar abono"
                          data-abono-id={order.id}
                          data-abono-total={order.total}
                          data-abono-actual={order.abonado}
                          data-abono-persona={order.persona}
                        >
                          <PaymentIcon badgeClass="w-4 h-4 text-[10px] group-hover:animate-bounce" />
                        </button>
                        <button
                          type="button"
                          class="inline-flex items-center justify-center w-10 h-10 rounded-xl border border-orange-500/30 bg-orange-500/10 hover:bg-orange-500/20 text-orange-400 transition-all duration-300 hover:scale-110 active:scale-95 cursor-pointer"
                          data-edit-styles-id={order.id}
                          data-edit-styles-persona={order.persona}
                          data-edit-styles-current={order.estiloIds}
                          title="Editar estilos"
                        >
                          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                          </svg>
                        </button>
                        <button
                          type="button"
                          class="inline-flex items-center justify-center w-9 h-9 rounded-full border border-red-500/30 bg-red-500/10 hover:bg-red-500/20 text-red-400 transition-colors cursor-pointer"
                          title="Borrar pedido"
                          aria-label="Borrar pedido"
                          data-delete-id={order.id}
                        >
                          <TrashIcon />
                        </button>
                      </div>
                    </td>
                  </tr>
                );
              })
            }
            {
              orders.length === 0 && (
                <tr>
                  <td
                    colspan="7"
                    class="px-6 py-20 text-center text-gray-500 italic"
                  >
                    No hay pedidos registrados aún.
                  </td>
                </tr>
              )
            }
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <div
    id="delete-modal"
    class="fixed inset-0 z-40 hidden items-center justify-center bg-black/60 px-4"
  >
    <div
      class="bg-[#151515] border border-white/10 rounded-2xl p-6 w-full max-w-md shadow-2xl animate-in fade-in zoom-in duration-200"
    >
      <div class="flex items-center gap-3 mb-4 text-red-500">
        <div class="w-10 h-10 rounded-full bg-red-500/10 flex items-center justify-center">
          <TrashIcon />
        </div>
        <h4 class="text-xl font-bold">Eliminar pedido</h4>
      </div>
      <p class="text-gray-400 mb-8 text-sm leading-relaxed">
        ¿Estás seguro de que quieres eliminar este pedido? Esta acción es irreversible y se perderán todos los datos asociados.
      </p>
      <div class="grid grid-cols-2 gap-3">
        <button
          type="button"
          id="delete-cancel"
          class="px-4 py-3 rounded-xl bg-white/5 hover:bg-white/10 text-white font-bold transition-colors"
        >
          Cancelar
        </button>
        <form method="post" action="/api/pedidos/delete" id="delete-form">
          <input type="hidden" name="id" id="delete-id" />
          <button
            type="submit"
            class="w-full px-4 py-3 rounded-xl bg-red-600 hover:bg-red-700 text-white font-bold shadow-lg shadow-red-600/20 transition-all active:scale-95"
          >
            Eliminar
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal de Abono -->
  <div
    id="abono-modal"
    class="fixed inset-0 z-40 hidden items-center justify-center bg-black/60 px-4"
  >
    <div
      class="bg-[#151515] border border-white/10 rounded-2xl p-6 w-full max-w-sm shadow-2xl animate-in fade-in zoom-in duration-200"
    >
      <div class="flex items-center gap-4 mb-6">
        <div class="w-14 h-14 rounded-2xl bg-blue-600/20 flex items-center justify-center text-blue-400 shadow-inner">
          <PaymentIcon class="w-8 h-8" badgeClass="w-5 h-5 text-xs animate-pulse" />
        </div>
        <div>
          <h4 class="text-2xl font-black text-white">Registrar Pago</h4>
          <p id="abono-subtitle" class="text-blue-400 font-bold tracking-widest text-xs uppercase"></p>
        </div>
      </div>
      
      <form method="post" action="/api/pedidos/abono" id="abono-form" class="space-y-4">
        <input type="hidden" name="id" id="abono-id" />
        
        <div class="space-y-1">
          <label class="text-xs font-bold text-gray-400 uppercase ml-1">Monto del Abono ($)</label>
          <input 
            type="number" 
            name="monto" 
            id="abono-monto" 
            step="0.01"
            class="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 focus:ring-2 focus:ring-blue-500 outline-none text-lg font-bold text-white"
            required
          />
          <p id="abono-total-hint" class="text-xs text-gray-500 mt-1 ml-1"></p>
        </div>

        <div class="grid grid-cols-2 gap-3 pt-2">
          <button
            type="button"
            id="abono-cancel"
            class="px-4 py-3 rounded-xl bg-white/5 hover:bg-white/10 text-white font-bold transition-colors"
          >
            Cancelar
          </button>
          <button
            type="submit"
            class="px-4 py-3 rounded-xl bg-blue-600 hover:bg-blue-700 text-white font-bold shadow-lg shadow-blue-600/20 transition-all active:scale-95"
          >
            Guardar
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal de Editar Estilos -->
  <div
    id="edit-styles-modal"
    class="fixed inset-0 z-40 hidden items-center justify-center bg-black/60 px-4"
  >
    <div
      class="bg-[#151515] border border-white/10 rounded-2xl p-6 w-full max-w-lg shadow-2xl animate-in fade-in zoom-in duration-200 overflow-y-auto max-h-[90vh]"
    >
      <div class="flex items-center gap-4 mb-6">
        <div class="w-14 h-14 rounded-2xl bg-orange-600/20 flex items-center justify-center text-orange-400 shadow-inner">
          <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
          </svg>
        </div>
        <div>
          <h4 class="text-2xl font-black text-white">Editar Estilos</h4>
          <p id="edit-styles-subtitle" class="text-orange-400 font-bold tracking-widest text-xs uppercase"></p>
        </div>
      </div>
      
      <form method="post" action="/api/pedidos/update-styles" id="edit-styles-form" class="space-y-6">
        <input type="hidden" name="id" id="edit-styles-id" />
        
        <div class="space-y-4">
          {collectionNumbers.map(collNum => (
            <div class="space-y-2">
              <h5 class="text-[10px] font-black text-gray-500 uppercase tracking-[0.2em] border-b border-white/5 pb-1">
                Colección {collNum}
              </h5>
              <div class="grid grid-cols-2 sm:grid-cols-3 gap-2">
                {groupedStyles[collNum].map(estilo => (
                  <label class="flex items-center gap-2 p-2 rounded-lg bg-white/5 border border-white/5 hover:bg-white/10 transition-colors cursor-pointer group">
                    <input 
                      type="checkbox" 
                      name="estilos" 
                      value={estilo.id}
                      class="w-4 h-4 rounded border-white/10 bg-black/40 text-orange-500 focus:ring-orange-500/20"
                    />
                    <span class="text-[10px] font-bold text-gray-400 group-hover:text-white transition-colors truncate">
                      {estilo.nombre}
                    </span>
                  </label>
                ))}
              </div>
            </div>
          ))}
        </div>

        <div class="grid grid-cols-2 gap-3 pt-2">
          <button
            type="button"
            id="edit-styles-cancel"
            class="px-4 py-3 rounded-xl bg-white/5 hover:bg-white/10 text-white font-bold transition-colors"
          >
            Cancelar
          </button>
          <button
            type="submit"
            class="px-4 py-3 rounded-xl bg-orange-600 hover:bg-orange-700 text-white font-bold shadow-lg shadow-orange-600/20 transition-all active:scale-95"
          >
            Guardar
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal de Editar Fecha -->
  <div
    id="edit-date-modal"
    class="fixed inset-0 z-40 hidden items-center justify-center bg-black/60 px-4"
  >
    <div
      class="bg-[#151515] border border-white/10 rounded-2xl p-6 w-full max-w-sm shadow-2xl animate-in fade-in zoom-in duration-200"
    >
      <div class="flex items-center gap-4 mb-6">
        <div class="w-14 h-14 rounded-2xl bg-purple-600/20 flex items-center justify-center text-purple-400 shadow-inner">
          <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
          </svg>
        </div>
        <div>
          <h4 class="text-2xl font-black text-white">Editar Fecha</h4>
          <p id="edit-date-subtitle" class="text-purple-400 font-bold tracking-widest text-xs uppercase"></p>
        </div>
      </div>
      
      <form method="post" action="/api/pedidos/update-date" id="edit-date-form" class="space-y-4">
        <input type="hidden" name="id" id="edit-date-id" />
        
        <div class="space-y-1">
          <label class="text-xs font-bold text-gray-400 uppercase ml-1">Nueva Fecha</label>
          <input 
            type="date" 
            name="date" 
            id="edit-date-input" 
            class="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 focus:ring-2 focus:ring-purple-500 outline-none text-lg font-bold text-white"
            required
          />
        </div>

        <div class="grid grid-cols-2 gap-3 pt-2">
          <button
            type="button"
            id="edit-date-cancel"
            class="px-4 py-3 rounded-xl bg-white/5 hover:bg-white/10 text-white font-bold transition-colors"
          >
            Cancelar
          </button>
          <button
            type="submit"
            class="px-4 py-3 rounded-xl bg-purple-600 hover:bg-purple-700 text-white font-bold shadow-lg shadow-purple-600/20 transition-all active:scale-95"
          >
            Actualizar
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal de Informe -->
  <div
    id="report-modal"
    class="fixed inset-0 z-40 hidden items-center justify-center bg-black/60 px-4"
  >
    <div
      class="bg-[#151515] border border-white/10 rounded-2xl p-6 w-full max-w-sm shadow-2xl animate-in fade-in zoom-in duration-200"
    >
      <div class="flex items-center gap-4 mb-6">
        <div class="w-14 h-14 rounded-2xl bg-green-600/20 flex items-center justify-center text-green-400 shadow-inner">
          <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
        </div>
        <div>
          <h4 class="text-2xl font-black text-white">Generar Informe</h4>
          <p class="text-green-400 font-bold tracking-widest text-xs uppercase">Filtrar por Fechas</p>
        </div>
      </div>
      
      <div class="space-y-4">
        <div class="grid grid-cols-2 gap-3">
          <div class="space-y-1">
            <label class="text-[10px] font-bold text-gray-400 uppercase ml-1">Desde</label>
            <input 
              type="date" 
              id="report-from" 
              class="w-full bg-black/40 border border-white/10 rounded-xl px-3 py-2.5 focus:ring-2 focus:ring-green-500 outline-none text-sm font-bold text-white"
            />
          </div>
          <div class="space-y-1">
            <label class="text-[10px] font-bold text-gray-400 uppercase ml-1">Hasta</label>
            <input 
              type="date" 
              id="report-to" 
              class="w-full bg-black/40 border border-white/10 rounded-xl px-3 py-2.5 focus:ring-2 focus:ring-green-500 outline-none text-sm font-bold text-white"
            />
          </div>
        </div>

        <div class="grid grid-cols-2 gap-3 pt-2">
          <button
            type="button"
            id="report-cancel"
            class="px-4 py-3 rounded-xl bg-white/5 hover:bg-white/10 text-white font-bold transition-colors"
          >
            Cancelar
          </button>
          <button
            type="button"
            id="report-generate"
            class="px-4 py-3 rounded-xl bg-green-600 hover:bg-green-700 text-white font-bold shadow-lg shadow-green-600/20 transition-all active:scale-95 flex items-center justify-center gap-2"
          >
            Descargar PDF
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    import { jsPDF } from 'jspdf';
    import autoTable from 'jspdf-autotable';

    console.log('Admin Pedidos Script Loaded');
    
    const elements = {
      modal: document.getElementById('delete-modal'),
      abonoModal: document.getElementById('abono-modal'),
      editStylesModal: document.getElementById('edit-styles-modal'),
      editDateModal: document.getElementById('edit-date-modal'),
      reportModal: document.getElementById('report-modal'),
      reportOpenBtn: document.getElementById('report-open')
    };
    console.log('Modal elements status:', elements);

    const modal = elements.modal;
    const deleteIdInput = document.getElementById('delete-id');
    const cancelBtn = document.getElementById('delete-cancel');

    // Abono Elements
    const abonoModal = document.getElementById('abono-modal');
    const abonoIdInput = document.getElementById('abono-id') as HTMLInputElement;
    const abonoMontoInput = document.getElementById('abono-monto') as HTMLInputElement;
    const abonoSubtitle = document.getElementById('abono-subtitle');
    const abonoTotalHint = document.getElementById('abono-total-hint');
    const abonoCancelBtn = document.getElementById('abono-cancel');

    // Edit Styles Elements
    const editStylesModal = document.getElementById('edit-styles-modal');
    const editStylesIdInput = document.getElementById('edit-styles-id') as HTMLInputElement;
    const editStylesSubtitle = document.getElementById('edit-styles-subtitle');
    const editStylesCancelBtn = document.getElementById('edit-styles-cancel');
    const editStylesForm = document.getElementById('edit-styles-form') as HTMLFormElement;

    // Edit Date Elements
    const editDateModal = document.getElementById('edit-date-modal');
    const editDateIdInput = document.getElementById('edit-date-id') as HTMLInputElement;
    const editDateInput = document.getElementById('edit-date-input') as HTMLInputElement;
    const editDateSubtitle = document.getElementById('edit-date-subtitle');
    const editDateCancelBtn = document.getElementById('edit-date-cancel');

    // Report Elements
    const reportModal = document.getElementById('report-modal');
    const reportOpenBtn = document.getElementById('report-open');
    const reportCancelBtn = document.getElementById('report-cancel');
    const reportGenerateBtn = document.getElementById('report-generate');
    const reportFromInput = document.getElementById('report-from') as HTMLInputElement;
    const reportToInput = document.getElementById('report-to') as HTMLInputElement;
    const headerElement = document.querySelector('header[data-orders]');

    // Report Modal Logic
    reportOpenBtn?.addEventListener('click', () => {
      console.log('Opening report modal');
      const now = new Date();
      const today = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
      if (reportFromInput) reportFromInput.value = today;
      if (reportToInput) reportToInput.value = today;
      
      if (reportModal) {
        reportModal.classList.remove('hidden');
        reportModal.classList.add('flex');
      }
    });

    document.addEventListener('click', (ev) => {
      const target = ev.target as HTMLElement | null;
      if (!target) return;
      
      console.log('Click detected on:', target);
      const deleteButton = target.closest('[data-delete-id]') as HTMLElement | null;
      if (deleteButton) {
        const id = deleteButton.getAttribute('data-delete-id');
        if (!id || !modal || !deleteIdInput) return;
        deleteIdInput.setAttribute('value', id);
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        return;
      }

      // Abono Modal Logic
      const abonoButton = target.closest('[data-abono-id]') as HTMLElement | null;
      if (abonoButton) {
        const id = abonoButton.getAttribute('data-abono-id');
        const total = parseFloat(abonoButton.getAttribute('data-abono-total') || '0');
        const actual = parseFloat(abonoButton.getAttribute('data-abono-actual') || '0');
        const persona = abonoButton.getAttribute('data-abono-persona');

        if (!id || !abonoModal || !abonoIdInput || !abonoMontoInput) return;

        abonoIdInput.value = id;
        const sugerido = actual > 0 ? actual : (total / 2);
        abonoMontoInput.value = sugerido.toFixed(2);
        
        if (abonoSubtitle) abonoSubtitle.textContent = persona;
        if (abonoTotalHint) abonoTotalHint.textContent = `Total del pedido: ${total.toFixed(2)}`;

        abonoModal.classList.remove('hidden');
        abonoModal.classList.add('flex');
        return;
      }

      // Edit Styles Modal Logic
      const editStylesButton = target.closest('[data-edit-styles-id]') as HTMLElement | null;
      if (editStylesButton) {
        const id = editStylesButton.getAttribute('data-edit-styles-id');
        const persona = editStylesButton.getAttribute('data-edit-styles-persona');
        const currentIds = editStylesButton.getAttribute('data-edit-styles-current')?.split(',') || [];

        if (!id || !editStylesModal || !editStylesIdInput || !editStylesForm) return;

        editStylesIdInput.value = id;
        if (editStylesSubtitle) editStylesSubtitle.textContent = persona;

        const checkboxes = editStylesForm.querySelectorAll('input[type="checkbox"]') as NodeListOf<HTMLInputElement>;
        checkboxes.forEach(cb => {
          cb.checked = currentIds.includes(cb.value);
        });

        editStylesModal.classList.remove('hidden');
        editStylesModal.classList.add('flex');
        return;
      }

      // Edit Date Modal Logic
      const editDateButton = target.closest('[data-edit-date-id]') as HTMLElement | null;
      if (editDateButton) {
        const id = editDateButton.getAttribute('data-edit-date-id');
        const persona = editDateButton.getAttribute('data-edit-date-persona');
        const currentDate = editDateButton.getAttribute('data-edit-date-current');

        if (!id || !editDateModal || !editDateIdInput || !editDateInput) return;

        editDateIdInput.value = id;
        if (editDateSubtitle) editDateSubtitle.textContent = persona;
        if (currentDate) {
          editDateInput.value = currentDate;
        } else {
          editDateInput.value = new Date().toISOString().split('T')[0];
        }

        editDateModal.classList.remove('hidden');
        editDateModal.classList.add('flex');
        return;
      }
    });

    // Report Logic
    reportCancelBtn?.addEventListener('click', () => {
      reportModal?.classList.add('hidden');
      reportModal?.classList.remove('flex');
    });

    reportGenerateBtn?.addEventListener('click', () => {
      console.log('Generating PDF...');
      const from = reportFromInput?.value;
      const to = reportToInput?.value;
      const ordersData = headerElement?.getAttribute('data-orders');

      if (!from || !to || !ordersData) return;

      const orders = JSON.parse(ordersData);
      
      // Parse dates using local time components to avoid timezone shifts
      const [fYear, fMonth, fDay] = from.split('-').map(Number);
      const fromDate = new Date(fYear, fMonth - 1, fDay, 0, 0, 0, 0);
      
      const [tYear, tMonth, tDay] = to.split('-').map(Number);
      const toDate = new Date(tYear, tMonth - 1, tDay, 23, 59, 59, 999);

      const filteredOrders = orders.filter((order: any) => {
        if (!order.createdAt) return false;
        // order.createdAt is usually a string like "2026-01-29 21:30:00"
        // new Date(string) usually parses as local if it has time, or UTC if it's just YYYY-MM-DD
        const orderDate = new Date(order.createdAt);
        return orderDate >= fromDate && orderDate <= toDate;
      });

      if (filteredOrders.length === 0) {
        alert('No hay pedidos en el rango de fechas seleccionado.');
        return;
      }

      const doc = new jsPDF();
      
      // Helper to format YYYY-MM-DD to DD/MM/YYYY
      const displayDate = (dateStr: string) => {
        const [y, m, d] = dateStr.split('-');
        return `${d}/${m}/${y}`;
      };

      // Header
      doc.setFontSize(20);
      doc.setTextColor(0, 0, 0);
      doc.text('Informe de Pedidos', 14, 20);
      
      doc.setFontSize(10);
      doc.setTextColor(100);
      doc.text(`Desde: ${displayDate(from)} Hasta: ${displayDate(to)}`, 14, 28);
      doc.text(`Generado el: ${new Date().toLocaleString()}`, 14, 33);

      const tableData = filteredOrders.map((order: any) => [
        order.createdAt ? new Date(order.createdAt).toLocaleDateString() : '---',
        order.persona,
        order.nombre,
        order.estilos || '---',
        order.talla,
        `$${order.total}`,
        `$${order.pagado ? 0 : (order.total - order.abonado)}`,
        order.pagado ? 'PAGADO' : (order.abonado > 0 ? `ABONADO ($${order.abonado})` : 'PENDIENTE')
      ]);

      autoTable(doc, {
        startY: 40,
        head: [['Fecha', 'Cliente', 'Nombre Camisa', 'Estilos', 'Talla', 'Total', 'Saldo', 'Estado']],
        body: tableData,
        headStyles: { fillColor: [21, 21, 21], textColor: [255, 255, 255], fontStyle: 'bold' },
        alternateRowStyles: { fillColor: [245, 245, 245] },
        styles: { fontSize: 8, cellPadding: 2 },
        columnStyles: {
          3: { cellWidth: 35 }, // Estilos
          6: { cellWidth: 15 }  // Saldo
        },
        margin: { top: 40 },
      });

      // Total info
      const finalY = (doc as any).lastAutoTable.finalY || 40;
      const totalAmount = filteredOrders.reduce((acc: number, o: any) => acc + o.total, 0);
      const totalPaid = filteredOrders.reduce((acc: number, o: any) => acc + (o.pagado ? o.total : o.abonado), 0);
      const totalPending = totalAmount - totalPaid;
      
      doc.setFontSize(12);
      doc.setTextColor(0);
      doc.text(`Total de pedidos: ${filteredOrders.length}`, 14, finalY + 15);
      doc.text(`Monto total: $${totalAmount.toFixed(2)}`, 14, finalY + 22);
      doc.text(`Monto recaudado: $${totalPaid.toFixed(2)}`, 14, finalY + 29);
      doc.text(`Monto pendiente: $${totalPending.toFixed(2)}`, 14, finalY + 36);

      doc.save(`informe-pedidos-${from}-a-${to}.pdf`);
      
      reportModal?.classList.add('hidden');
      reportModal?.classList.remove('flex');
    });

    cancelBtn?.addEventListener('click', () => {
      modal?.classList.add('hidden');
      modal?.classList.remove('flex');
      deleteIdInput?.setAttribute('value', '');
    });

    abonoCancelBtn?.addEventListener('click', () => {
      abonoModal?.classList.add('hidden');
      abonoModal?.classList.remove('flex');
    });

    editStylesCancelBtn?.addEventListener('click', () => {
      editStylesModal?.classList.add('hidden');
      editStylesModal?.classList.remove('flex');
    });

    editDateCancelBtn?.addEventListener('click', () => {
      editDateModal?.classList.add('hidden');
      editDateModal?.classList.remove('flex');
    });

    // Close on backdrop click
    [modal, abonoModal, editStylesModal, editDateModal, reportModal].forEach(m => {
      m?.addEventListener('click', (ev) => {
        if (ev.target === m) {
          m.classList.add('hidden');
          m.classList.remove('flex');
        }
      });
    });
  </script>
</Layout>
